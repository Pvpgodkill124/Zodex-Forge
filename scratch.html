<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Zodex Forge Scratch</title>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <style>
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    header, footer {
      text-align: center;
      padding: 10px;
      background: #222;
    }
    #blocklyDiv {
      height: 400px;
      width: 100%;
    }
    .controls {
      display: flex;
      justify-content: center;
      margin: 10px;
    }
    iframe {
      border: 1px solid #444;
      width: 100%;
      height: 300px;
      background: white;
    }
    button {
      margin: 5px;
      padding: 8px 15px;
      background: #444;
      color: white;
      border: none;
      border-radius: 6px;
    }
  </style>
</head>
<body>

<header>
  <h1>Zodex Forge - Scratch Mode</h1>
</header>

<div id="blocklyDiv"></div>

<xml id="toolbox" style="display: none">
  <category name="HTML" colour="#5BA58C">
    <block type="html_body"></block>
    <block type="html_heading"></block>
    <block type="html_paragraph"></block>
  </category>
  <category name="JavaScript" colour="#5C81A6">
    <block type="alert_block"></block>
  </category>
</xml>

<div class="controls">
  <button onclick="runCode()">‚ö° Live Preview</button>
  <button onclick="saveDraft()">üíæ Save Draft</button>
  <button onclick="exportCode()">‚¨áÔ∏è Export</button>
  <button onclick="goToProjects()">üìÅ Projects</button>
</div>

<iframe id="preview"></iframe>

<footer>DR1TRA-GAMING | Zodex Scratch V1</footer>

<script>
  const workspace = Blockly.inject('blocklyDiv', {
    toolbox: document.getElementById('toolbox'),
    theme: Blockly.Themes.Dark,
  });

  // BLOCK DEFINITIONS
  Blockly.defineBlocksWithJsonArray([
    {
      "type": "html_body",
      "message0": "<body> %1 </body>",
      "args0": [{ "type": "input_statement", "name": "content" }],
      "previousStatement": null,
      "nextStatement": null,
      "colour": 160
    },
    {
      "type": "html_heading",
      "message0": "<h1> %1 </h1>",
      "args0": [{ "type": "field_input", "name": "text", "text": "Heading" }],
      "previousStatement": null,
      "nextStatement": null,
      "colour": 210
    },
    {
      "type": "html_paragraph",
      "message0": "<p> %1 </p>",
      "args0": [{ "type": "field_input", "name": "text", "text": "Paragraph" }],
      "previousStatement": null,
      "nextStatement": null,
      "colour": 210
    },
    {
      "type": "alert_block",
      "message0": "alert %1",
      "args0": [{ "type": "field_input", "name": "text", "text": "Hello!" }],
      "previousStatement": null,
      "nextStatement": null,
      "colour": 230
    }
  ]);

  // GENERATOR CODE
  Blockly.JavaScript['html_body'] = function (block) {
    const content = Blockly.JavaScript.statementToCode(block, 'content');
    return `<body>\n${content}</body>\n`;
  };
  Blockly.JavaScript['html_heading'] = function (block) {
    const text = block.getFieldValue('text');
    return `<h1>${text}</h1>\n`;
  };
  Blockly.JavaScript['html_paragraph'] = function (block) {
    const text = block.getFieldValue('text');
    return `<p>${text}</p>\n`;
  };
  Blockly.JavaScript['alert_block'] = function (block) {
    const text = block.getFieldValue('text');
    return `alert("${text}");\n`;
  };

  // LIVE PREVIEW
  function runCode() {
    const code = Blockly.JavaScript.workspaceToCode(workspace);
    const html = `<html><head><script>${code}<\/script></head><body style="background:#fff;color:#000">${code}</body></html>`;
    const iframe = document.getElementById('preview');
    iframe.srcdoc = html;
  }

  // SAVE TO DRAFT
  function saveDraft() {
    const xml = Blockly.Xml.workspaceToDom(workspace);
    localStorage.setItem("zodex-scratch", Blockly.Xml.domToText(xml));
  }

  // EXPORT CODE
  function exportCode() {
    const code = Blockly.JavaScript.workspaceToCode(workspace);
    const blob = new Blob([code], { type: "text/html" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "zodex-scratch.html";
    a.click();
  }

  // LOAD ON START
  window.onload = () => {
    const saved = localStorage.getItem("zodex-scratch");
    if (saved) {
      Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(saved), workspace);
    }
  };

  function goToProjects() {
    window.location.href = "scratch-project.html";
  }
</script>

</body>
</html>
